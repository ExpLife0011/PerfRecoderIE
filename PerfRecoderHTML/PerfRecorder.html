<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
		  "http://www.w3.org/TR/html4/loose.dtd">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>PerfRecorder</title>
		<script type="text/javascript" src="./js/jquery-1.11.3.js"></script>
		<script type="text/javascript" src="./js/highcharts.js"></script>
	</head>
	<body>
		<object id="PerfRecoder" classid="CLSID:8F1B6710-FCCD-4DC8-B24F-26294818D793"></object>
		<div id="gpuMem"></div>

		<script type="text/javascript">
			$(function () {
				var PerfRecoder = document.getElementById('PerfRecoder');
				var gpuIds = JSON.parse(PerfRecoder.getPhysicalGPUIds());
				var gpuId = gpuIds[0];
				var interval = 800;

				$('#gpuMem').highcharts({
					chart: {
						type: 'spline',
						events: {
							load: function () {
								var series = this.series;
								setInterval(function () {
									var usage = PerfRecoder.getGPUUsages(gpuId);
									var info = JSON.parse(PerfRecoder.getGPUMemoryInfo(gpuId));
									var time = (new Date()).getTime();
									var usedMemory = info.dedicatedVideoMemory - info.curAvailableDedicatedVideoMemory;
									usedMemory /= 1024;
									series[0].addPoint([time, usedMemory], true, true);
									series[1].addPoint([time, usage], true, true);
									console.log(info);
								}, interval);
							}
						}
					},
					title: {
						text: PerfRecoder.getGPUFullName(gpuId)
					},
					xAxis: {
						type: 'datetime',
						tickPixelInterval: 150
					},
					yAxis: [{
						title: {
							text: '显存使用'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						labels: {
							formatter: function () {
								return Highcharts.numberFormat(this.value, 2) + 'MB';
							}
						}
					}, {
						title: {
							text: 'GPU使用率'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#4572A7'
						}],
						labels: {
							formatter: function () {
								return Highcharts.numberFormat(this.value, 2) + '%';
							}
						},
						opposite: true
					}],
					tooltip: {
						shared: true,
						valueDecimals: 2,
						dateTimeLabelFormats: {
							millisecond: '%H:%M:%S.%L'
						}
					},
					legend: {
						enabled: true
					},
					series: [{                                                              
						name: '显存使用',
						data: function () {
							var data = [];
							var time = (new Date()).getTime();
							for (var i = -50; i <= 0; ++i)
								data.push({ x: time + i * interval, y: 0 });
							return data;
						}(),
						tooltip: {
							valueSuffix: 'MB'
						}
					}, {
						name: 'GPU使用率',
						data: function () {
							var data = [];
							var time = (new Date()).getTime();
							for (var i = -50; i <= 0; ++i)
								data.push({ x: time + i * interval, y: 0 });
							return data;
						}(),
						tooltip: {
							valueSuffix: '%'
						}
					}]
				});
			});
		</script>
	</body>
</html>